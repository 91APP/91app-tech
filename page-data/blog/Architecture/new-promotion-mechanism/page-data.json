{"componentChunkName":"component---src-templates-blog-template-tsx","path":"/blog/Architecture/new-promotion-mechanism","result":{"data":{"markdownRemark":{"html":"<p>這個主題我們會和大家分享透過抽象化思維精心設計出的全新促購引擎來因應市場變化取得先機，其中會簡介系統架構與技術細節，以及新促購引擎帶來的效益與新的挑戰。</p>\n<p>很高興在這邊和大家分享在電商技術中非常重要一環的促購機制，在 91APP 我們有著與以往完全不同的新促購機制，我們透過抽象化的思維精心設計出全新的促購引擎，這個優秀的系統設計思維可以讓系統未來的發展性與維護性帶來巨大的效益，對於瞬息萬變的市場變化，也有著良好的適應性，讓企業得以應變並取得先機，就讓我們一起來瞭解 91APP 的促購引擎吧！</p>\n<hr>\n<h1 id=\"0-大綱\" style=\"position:relative;\"><a href=\"#0-%E5%A4%A7%E7%B6%B1\" aria-label=\"0 大綱 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>0. 大綱</h1>\n<p>在這整個主題中我們將會細分為四個小節來向大家詳細說明，首先，我們會先介紹新促購機制的來龍去脈並說明新促購引擎的系統架構與技術細節；第二，我們會分享在使用進化後的促購引擎為我們帶來了什麼樣實際的效益；第三，我們也揭露在這個新促購機制完成後，我們所接受到那些新的挑戰；最後，我們會針對新促購機制的重點做個總結。</p>\n<hr>\n<h1 id=\"1-新促購機制-──-簡介新促購引擎\" style=\"position:relative;\"><a href=\"#1-%E6%96%B0%E4%BF%83%E8%B3%BC%E6%A9%9F%E5%88%B6-%E2%94%80%E2%94%80-%E7%B0%A1%E4%BB%8B%E6%96%B0%E4%BF%83%E8%B3%BC%E5%BC%95%E6%93%8E\" aria-label=\"1 新促購機制 ── 簡介新促購引擎 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 新促購機制 ── 簡介新促購引擎</h1>\n<p>在這一小節我們會先介紹新促購機制的來龍去脈並說明新促購引擎的系統架構與技術細節。</p>\n<h2 id=\"11-背景\" style=\"position:relative;\"><a href=\"#11-%E8%83%8C%E6%99%AF\" aria-label=\"11 背景 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1. 背景</h2>\n<p>我們先來說明一下什麼是促購。</p>\n<blockquote>\n<p>促購是指商店向消費者傳遞有關產品的各種訊息，吸引消費者注意商店的產品、<font color=\"red\"><strong>激發消費者的購買欲望</strong></font>，並促使其實現最終的購買行為。常用的<font color=\"red\"><strong>促購方式有降價、打折、贈送等方式</strong></font>。商店可根據實際情況及市場、產品等因素<font color=\"red\"><strong>選擇一種或多種促購方式的組合</strong></font><sup>[<a href=\"https://wiki.mbalib.com/zh-tw/%E4%BF%83%E9%94%80\">1</a>, <a href=\"https://www.itsfun.com.tw/%E9%8A%B7%E5%94%AE%E4%BF%83%E9%80%B2/wiki-0237365-7679935\">2</a>]</sup>。</p>\n</blockquote>\n<p><a href=\"https://commons.wikimedia.org/wiki/File:Sales_promotion_2015_0001.JPG\" target=\"_blank\"><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.87116564417178%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBP/EABUBAQEAAAAAAAAAAAAAAAAAAAID/9oADAMBAAIQAxAAAAFa4wVkKKf/xAAZEAACAwEAAAAAAAAAAAAAAAABAgADERL/2gAIAQEAAQUCCqA69zmWNkewhd2f/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAS/9oACAEDAQE/ARMz/8QAFhEAAwAAAAAAAAAAAAAAAAAAEBEh/9oACAECAQE/AVR//8QAGRAAAgMBAAAAAAAAAAAAAAAAABEBEDFh/9oACAEBAAY/AsjBUuDgZ//EABoQAQADAQEBAAAAAAAAAAAAAAEAESExQVH/2gAIAQEAAT8hR3AA4A7WRopMNOwOrL+7HBek/9oADAMBAAIAAwAAABC/z//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/EBMJ/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAh/9oACAECAQE/EFbn/8QAGhABAQEBAQEBAAAAAAAAAAAAAREhAEFRsf/aAAgBAQABPxAwI6C+8DGW4Vn153JRmPPDUts6+IogP0cnoAszzv/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Sales promotion\"\n        title=\"Sales promotion\"\n        src=\"/static/8e84111d100315ce13ebcfb1a9ce7f06/6aca1/sales-promotion.jpg\"\n        srcset=\"/static/8e84111d100315ce13ebcfb1a9ce7f06/d2f63/sales-promotion.jpg 163w,\n/static/8e84111d100315ce13ebcfb1a9ce7f06/c989d/sales-promotion.jpg 325w,\n/static/8e84111d100315ce13ebcfb1a9ce7f06/6aca1/sales-promotion.jpg 650w,\n/static/8e84111d100315ce13ebcfb1a9ce7f06/7c09c/sales-promotion.jpg 975w,\n/static/8e84111d100315ce13ebcfb1a9ce7f06/01ab0/sales-promotion.jpg 1300w,\n/static/8e84111d100315ce13ebcfb1a9ce7f06/e5bc7/sales-promotion.jpg 5184w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></a></p>\n<p>我們現在的促購活動種類非常多，而且在折扣方式上也是相當複雜且變化多端，這邊舉幾個常見促購活動的例子，例如：</p>\n<ul>\n<li><strong>指定商品任選優惠價</strong>，像是：滿 2 件，合計 399 圓；</li>\n<li><strong>現折</strong>：滿 1000 圓，全部折 100 圓；</li>\n<li><strong>第 N 件折扣</strong>：滿 2 件，第 2 件 6 折；</li>\n<li><strong>紅配綠</strong>：1 件紅標商品加 1 件綠標商品，合計 999 圓。</li>\n</ul>\n<p>等等更多更複雜更多變的折扣方式，還有未來新型的促購活動。</p>\n<h2 id=\"12-動機\" style=\"position:relative;\"><a href=\"#12-%E5%8B%95%E6%A9%9F\" aria-label=\"12 動機 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2. 動機</h2>\n<p>身為全通路新零售解決方案平臺，我們希望能夠使用更多變更多重的折扣方式，以搭配商店的促購活動帶動業績，讓商店與消費者達到雙贏的目標。同時我們也希望簡化購物車計算流程，抽象化折扣計算邏輯以便日後的維運，並對未來市場上促購活動的變化有著良好的適應性，使得我們能夠快速開發新的折扣方式為商店取得先機。</p>\n<!-- * 實現新促購機制的動機：\n  * 使用更多變更多重的折扣方式，以搭配商店的促購活動。\n  * 簡化購物車計算金額流程，抽象化折扣計算邏輯以便日後維運。 -->\n<h2 id=\"13-目標\" style=\"position:relative;\"><a href=\"#13-%E7%9B%AE%E6%A8%99\" aria-label=\"13 目標 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3. 目標</h2>\n<p>我們對於新的促購機制訂下兩個目標：第一，我們希望統一運算規則以解決商業邏輯不一致，難以驗證溝通等等的問題；第二，打造可以擴充的計算引擎，將折扣規則標準化，加速開發與上線的時程。接下來我們將朝著這兩個目標一步一步實現我們的新促購機制。</p>\n<!-- * 統一運算規則：\n  * 解決商業邏輯不一致，難以驗證溝通等問題。\n* 打造可擴充的計算引擎：\n  * 折扣規則標準化，加速開發與上線時程。 -->\n<h2 id=\"14-挑戰\" style=\"position:relative;\"><a href=\"#14-%E6%8C%91%E6%88%B0\" aria-label=\"14 挑戰 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.4. 挑戰</h2>\n<p>要實現我們的目標會先面臨到幾個統整折扣規則的主要挑戰，就像我們先前提到的促購活動範例一樣，首先，遇到的挑戰是各個折扣規則皆大不相同，以及，各個折扣規則適用的商品範圍也是都完全不同，還有，各種折扣規則的組合順序，例如：要考慮是否先計算紅配綠再計算現折等等的組合順序。而這些困難的挑戰都是一個優秀的促購機制必須面對的議題。</p>\n<!-- * 統整折扣規則的挑戰：\n  * 完全不同的折扣規則；\n  * 完全不同的適用商品範圍；\n  * 各種折扣規則的組合順序。 -->\n<h2 id=\"15-解決方案\" style=\"position:relative;\"><a href=\"#15-%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%A1%88\" aria-label=\"15 解決方案 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.5. 解決方案</h2>\n<p>在分享解決方案前，我們先來快速說明在物件導向程式設計中非常重要的抽象化，藉由 91APP 首席架構師 Andrew 所分享文章中對抽象化的解釋，我們可以知道物件導向程式設計中的抽象化是：「提取重點」與「隱藏細節」。而提取重點的目的是為了讓主系統只依照被提取的重點設計流程；隱藏細節的目的則是讓跟重點無關的細節不會影響主系統的設計；即使日後改變細節也不會影響到主系統的運作<sup>[<a href=\"#reference3\">3</a>]</sup>。這樣設計的好處我們稍後就可以清楚的看到了！</p>\n<blockquote>\n<ul>\n<li>\n<p>什麼是抽象化：</p>\n<ul>\n<li><strong>提取重點</strong>：讓主系統只依照被提取的重點設計流程；</li>\n<li><strong>隱藏細節</strong>：讓跟重點無關的細節不會影響主系統的設計<sup>[<a href=\"#reference3\">3</a>]</sup>。</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<p>為了克服挑戰達成目標，透過物件導向程式設計的抽象化來設計我們的系統，首先，必須要先知道我們要解決的問題須要提取什麼樣的重點，以及隱藏什麼樣的細節。從購物車結帳流程的角度來看，購物車只需要知道那些商品符合折扣條件，以及符合折扣後的折抵金額就可繼續進行結帳流程。所以，我們<font color=\"red\"><strong>提取最終的折扣金額</strong></font>，以及<font color=\"red\"><strong>隱藏折扣的計算規則</strong></font>。這個良好的抽象化結果可以符合我們目標，在購物車結帳流程中無論未來有任何新的折扣規則，皆可計算出最終的折扣金額順利地進行結帳。</p>\n<!-- * 由購物車結帳流程抽象化促購引擎：\n  * 提取重點：提取最終折扣金額；\n  * 隱藏細節：隱藏折扣計算規則。 -->\n<p>我們從這張概念圖來說明，在購物車結帳時不需要知道折扣是如何計算，也不需知道折扣的規則是什麼，僅需要關注在計算後的折扣金額即可，所以我們將購物車裡的商品資訊傳給促購引擎，由引擎負責計算並將計算完的折扣金額回傳給購物車繼續進行結帳。換句話說無論未來折扣規則如何變化購物車的結帳流程還是不變，一樣將商品傳入取得折扣金額即可。</p>\n<ul>\n<li>將結帳流程抽象化：</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ddc9aac5626703cfd55c575a0f9363d7/0931d/abstract-the-checkout-process.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.89570552147239%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAACGUlEQVQoz21TaXMSQRDlj/NXApqSH6Bl1DICGg4FUyj5YhIgXLIL7LIXe80ezzezUEF0qrp2unf6Tb/uNyUhBI4rx/9XFkUIBgP4/T68TgduvY7E3BU5aYo8ywrLc5R0XUetVkOj2USeJAgeHyE2G4SzGYKnKaLFkvFU/UOaFcbkf28loEhQiuMY5XIZlUpFxaP5gmBzWJ0unO5X2L2+AkscF9FKQ7xew10s4NHC1QqxpjO+UizkuZKkbNs29vs9sry4WTBpS8B58zMc0gwfHuANhzAaTdjtDtrVKrovLzF7/0H5xvUnJNstqyTl06plDxSgvsaGBycfr+EOfqj+pL4PYRgQ7F2y2/FrHox7w0QWhEWFEuTU5EpYofblBnev38CTgDyYeh5i9lZsDfiaBp+9j9aFL+OZHxSAp9WdVzitN+D0DpR/kjJ9u9VG6+IC3eoLPL29gkXfIBNxTvkccEvABXumKDOuKEuKpJtaFhJpO0v5Mv5M+aCfo5aOlPWbFn5dvSPlAbIwVIkhJSQnao5GsMYT7Odz5YeceLb3mZj+PZTjEuyNwSn/Zh/VlKlNb3gHU06dcTnh3qsapnLK9E0KXWpXarEU8XBMEUfsU7xcUlcagskE1rcebGnfbwvdskpFkxLLXBep46i9MsbzKC6EHY3HCii8v4eQYKQTS3HzlQSjMSJelsvnKV+I7LG0LH/eH0w9QZ77A78ihKDtGclEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"將結帳流程抽象化\"\n        title=\"將結帳流程抽象化\"\n        src=\"/static/ddc9aac5626703cfd55c575a0f9363d7/a6d36/abstract-the-checkout-process.png\"\n        srcset=\"/static/ddc9aac5626703cfd55c575a0f9363d7/222b7/abstract-the-checkout-process.png 163w,\n/static/ddc9aac5626703cfd55c575a0f9363d7/ff46a/abstract-the-checkout-process.png 325w,\n/static/ddc9aac5626703cfd55c575a0f9363d7/a6d36/abstract-the-checkout-process.png 650w,\n/static/ddc9aac5626703cfd55c575a0f9363d7/e548f/abstract-the-checkout-process.png 975w,\n/static/ddc9aac5626703cfd55c575a0f9363d7/3c492/abstract-the-checkout-process.png 1300w,\n/static/ddc9aac5626703cfd55c575a0f9363d7/0931d/abstract-the-checkout-process.png 1373w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>接下來，我們會透過範例程式碼說明我們促購引擎的實作概念。在隱藏折扣計算的細節後，購物車結帳流程需要處理的項目只有：第一，描述商品資訊（包含品名、標籤及售價）；第二，呼叫引擎進行的折扣計算；最後，結帳的收據明細顯示。</p>\n<!-- * 隱藏折扣計算細節後，購物車結帳要處理的項目：\n  1. 描述商品資訊（包含品名、標籤及售價）；\n  2. 呼叫引擎進行的折扣計算；\n  3. 結帳的收據明細顯示。 -->\n<p>我們先從定義系統架構開始，在 <code>Main</code> 方法中我們模擬購物車結帳的流程，首先，初始化購物車 <code>Context</code>，並將購買的商品加入到購物車中，再初始化 <code>POS</code> 物件，也將啟用的折扣規則載入；接著，就可以呼叫結帳方法 <code>CheckoutProcess</code> 進行結帳，最後將計算結果列印出來，這樣大致就完成了整個結帳流程的系統架構，這邊也就呼應上述購物車結帳要處理的項目囉！</p>\n<ul>\n<li>定義系統架構（<a href=\"https://github.com/Zhi-Wei/Andrew.DiscountDemo/blob/master/Program.cs#L14-L33\">完整範例程式碼</a>）：</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"cs\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">private</span><span class=\"mtk1\"> </span><span class=\"mtk4\">static</span><span class=\"mtk1\"> </span><span class=\"mtk4\">void</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Main</span><span class=\"mtk1\">(</span><span class=\"mtk4\">string</span><span class=\"mtk1\">[] </span><span class=\"mtk12\">args</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 初始化購物車 Context 與 POS 物件。</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">var</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cart</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">CartContext</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">var</span><span class=\"mtk1\"> </span><span class=\"mtk12\">pos</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Pos</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 1. 購物車加入購買商品。</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PurchasedItems</span><span class=\"mtk1\">.</span><span class=\"mtk11\">AddRange</span><span class=\"mtk1\">(</span><span class=\"mtk11\">LoadProducts</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// POS 加入啟用的折扣規則。</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pos</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ActivatedRules</span><span class=\"mtk1\">.</span><span class=\"mtk11\">AddRange</span><span class=\"mtk1\">(</span><span class=\"mtk11\">LoadRules</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 2. 對購物車 Context 進行結帳。</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">pos</span><span class=\"mtk1\">.</span><span class=\"mtk11\">CheckoutProcess</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cart</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 3. 列印收據。</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">PrintReceipt</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cart</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>接著，我們來看一下 <code>POS</code> 的 <code>CheckoutProcess</code> 結帳方法細節，在這個方法的重點只需要計算商品的總價，以及逐一呼叫折扣規則的 <code>Process</code> 方法取得折扣資訊即可，完全不需要知道折扣規則的邏輯與細節就可以取得折扣資訊繼續進行結帳；這裡我們就是透過抽象化折扣規則與多型的應用達到的效果。那麼，抽象化的折扣規則是什麼呢？</p>\n<ul>\n<li>POS 的結帳方法（<a href=\"https://github.com/Zhi-Wei/Andrew.DiscountDemo/blob/master/Pos.cs#L12-L27\">完整範例程式碼</a>）：</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"cs\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">bool</span><span class=\"mtk1\"> </span><span class=\"mtk11\">CheckoutProcess</span><span class=\"mtk1\">(</span><span class=\"mtk10\">CartContext</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// Reset Cart.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">.</span><span class=\"mtk12\">AppliedDiscounts</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Clear</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 計算總價。</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TotalPrice</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PurchasedItems</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Select</span><span class=\"mtk1\">(</span><span class=\"mtk12\">p</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk12\">p</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Price</span><span class=\"mtk1\">).</span><span class=\"mtk11\">Sum</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 計算折扣。</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">foreach</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">var</span><span class=\"mtk1\"> </span><span class=\"mtk12\">discounts</span><span class=\"mtk1\"> </span><span class=\"mtk15\">in</span><span class=\"mtk1\"> </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">ActivatedRules</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Select</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">rule</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk12\">rule</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Process</span><span class=\"mtk1\">(</span><span class=\"mtk12\">cart</span><span class=\"mtk1\">).</span><span class=\"mtk11\">ToArray</span><span class=\"mtk1\">()))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">.</span><span class=\"mtk12\">AppliedDiscounts</span><span class=\"mtk1\">.</span><span class=\"mtk11\">AddRange</span><span class=\"mtk1\">(</span><span class=\"mtk12\">discounts</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TotalPrice</span><span class=\"mtk1\"> -= </span><span class=\"mtk12\">discounts</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Select</span><span class=\"mtk1\">(</span><span class=\"mtk12\">d</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk12\">d</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Amount</span><span class=\"mtk1\">).</span><span class=\"mtk11\">Sum</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">true</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>那我們來看一下折扣規則的抽象化介面是如何定義，其實非常簡單，除了折扣規則的基本資訊像是：<code>ID</code>、<code>Name</code> 與 <code>Note</code> 之外，就只有一個要實作的抽象方法 <code>Process</code> 而已。所有的折扣規則只需要繼承這個 <code>RuleBase</code> 類別後，在覆寫的 <code>Process</code> 方法中實作自己的折扣邏輯就可讓前一頁提到的 <code>CheckoutProcess</code> 結帳方法呼叫並進行結帳。接下來，我們就一起來實作折扣規則吧！</p>\n<ul>\n<li>定義折扣規則的抽象化介面（<a href=\"https://github.com/Zhi-Wei/Andrew.DiscountDemo/blob/master/Rules/RuleBase.cs#L6-L15\">完整範例程式碼</a>）：</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"cs\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">abstract</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">RuleBase</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">int</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Id</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">get</span><span class=\"mtk1\">; </span><span class=\"mtk4\">set</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Name</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">get</span><span class=\"mtk1\">; </span><span class=\"mtk4\">set</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">string</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Note</span><span class=\"mtk1\"> { </span><span class=\"mtk4\">get</span><span class=\"mtk1\">; </span><span class=\"mtk4\">set</span><span class=\"mtk1\">; }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">abstract</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IEnumerable</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Discount</span><span class=\"mtk1\">&gt; </span><span class=\"mtk11\">Process</span><span class=\"mtk1\">(</span><span class=\"mtk10\">CartContext</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>我們嘗試實作第一個折扣規則：<strong>任兩箱結帳 88 折</strong>。就像剛才提到的一樣，這個折扣規則只需要繼承 <code>RuleBase</code> 抽象類別後，實作自己的 <code>Process</code> 方法即可，我們粗略的看一下這個方法如何實作；也是很簡單，只要逐一檢查購買的商品是否有符合折扣條件，若符合就回傳計算後的折扣資訊即可。那我們還有其他的折扣規則要怎麼做呢？</p>\n<ul>\n<li>實作第一個折扣規則：任兩箱結帳 88 折（<a href=\"https://github.com/Zhi-Wei/Andrew.DiscountDemo/blob/master/Rules/BuyMoreBoxesDiscountRule.cs#L20-L42\">完整範例程式碼</a>）：</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"cs\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">BuyMoreBoxesDiscountRule</span><span class=\"mtk1\"> : </span><span class=\"mtk10\">RuleBase</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">override</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IEnumerable</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Discount</span><span class=\"mtk1\">&gt; </span><span class=\"mtk11\">Process</span><span class=\"mtk1\">(</span><span class=\"mtk10\">CartContext</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk4\">var</span><span class=\"mtk1\"> </span><span class=\"mtk12\">matchedProducts</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">List</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Product</span><span class=\"mtk1\">&gt;();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">foreach</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">var</span><span class=\"mtk1\"> </span><span class=\"mtk12\">p</span><span class=\"mtk1\"> </span><span class=\"mtk15\">in</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PurchasedItems</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">matchedProducts</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Add</span><span class=\"mtk1\">(</span><span class=\"mtk12\">p</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">matchedProducts</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Count</span><span class=\"mtk1\"> != </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_boxCount</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk15\">continue</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// 符合折扣</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">yield</span><span class=\"mtk1\"> </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Discount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">Amount</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">matchedProducts</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Select</span><span class=\"mtk1\">(</span><span class=\"mtk12\">product</span><span class=\"mtk1\"> =&gt; </span><span class=\"mtk12\">product</span><span class=\"mtk1\">.</span><span class=\"mtk12\">Price</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                    .</span><span class=\"mtk11\">Sum</span><span class=\"mtk1\">() * </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_percentOff</span><span class=\"mtk1\"> / </span><span class=\"mtk7\">100</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">Products</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">matchedProducts</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ToArray</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">Rule</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">this</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">matchedProducts</span><span class=\"mtk1\">.</span><span class=\"mtk11\">Clear</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>我們就再來擴充第二個折扣規則：<strong>消費滿 1000 折抵 100</strong>，就跟上一個折扣規則一樣，繼承 <code>RuleBase</code> 類別實作 <code>Process</code> 方法，在 <code>Process</code> 方法中判斷符合條件就回傳折扣資訊。像這樣，我們讓每個折扣規則只需要關注自己的折扣邏輯，不用知道結帳流程是如何處理，反過來說結帳流程也不需要知道折扣的規則，大幅降低了雙方的複雜度與耦合度，未來在開發新的折扣規則也就能更加簡單、更加快速！</p>\n<ul>\n<li>擴充第二個折扣規則：消費滿 1000 折抵 100（<a href=\"https://github.com/Zhi-Wei/Andrew.DiscountDemo/blob/master/Rules/TotalPriceDiscountRule.cs#L19-L30\">完整範例程式碼</a>）：</li>\n</ul>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"cs\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">TotalPriceDiscountRule</span><span class=\"mtk1\"> : </span><span class=\"mtk10\">RuleBase</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">public</span><span class=\"mtk1\"> </span><span class=\"mtk4\">override</span><span class=\"mtk1\"> </span><span class=\"mtk10\">IEnumerable</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Discount</span><span class=\"mtk1\">&gt; </span><span class=\"mtk11\">Process</span><span class=\"mtk1\">(</span><span class=\"mtk10\">CartContext</span><span class=\"mtk1\"> </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">cart</span><span class=\"mtk1\">.</span><span class=\"mtk12\">TotalPrice</span><span class=\"mtk1\"> &gt; </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_minDiscountPrice</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk15\">yield</span><span class=\"mtk1\"> </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Discount</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">Amount</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">_discountAmount</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">Rule</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">this</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                </span><span class=\"mtk12\">Products</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">cart</span><span class=\"mtk1\">.</span><span class=\"mtk12\">PurchasedItems</span><span class=\"mtk1\">.</span><span class=\"mtk11\">ToArray</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            };</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>我們這邊再針對範例程式碼和大家分享幾個關鍵點，首先是折扣規則的抽象化，從上述的程式碼可以看到，我們將<strong>折扣規則抽象化為 <code>RuleBase</code> 的抽象類別，而實作的折扣規則都只要關注本身的折扣邏輯</strong>，其餘的結帳、計算最終金額與顯示收據等則不在其中。</p>\n<!-- * 折扣規則的抽象化：\n  * 將折扣規則抽象化為 `RuleBase` 的抽象類別；\n  * 實作折扣規則本身的折扣邏輯。 -->\n<p>另一個關鍵點是多型的應用，在結帳的 <code>CheckoutProcess</code> 方法中，由於已經將折扣規則抽象化所以只需要：第一，計算原價；再來，將商品傳給每個折扣規則進行處理，取得折扣資訊；最後，回傳最終結帳金額，就完成了。而在<strong>呼叫折扣規則都只透過 <code>RuleBase</code> 定義的 <code>Process</code> 方法存取</strong>，而剩下的折扣計算，透過物件導向程式設計的多型機制，就會幫我們重新導向到每個衍生類別自己定義的邏輯進行處理。</p>\n<!-- * 多型的應用：\n  * `CheckoutProcess` 結帳方法僅需依步驟執行；\n  * 僅需透過 `RuleBase` 定義的 `Process` 方法存取。 -->\n<p>經過開發前期仔細的思考與分析，透過抽象化的方法設計出新促購機制的解決方案，符合我們的預期並達到了目標，<strong><font color=\"red\">統一了運算規則</font>，抽象化結帳流程讓折扣的運算皆交由促購引擎計算並取的最終的折購金額；<font color=\"red\">也打造可擴充的計算引擎</font>，抽象化折扣規則讓任何依照合約實作的折扣規則皆可擴充至促購引擎</strong>。</p>\n<!-- * 達到目標：\n  * 統一運算規則：抽象化結帳流程讓折扣的運算皆交由促購引擎計算取的最終的折購金額。\n  * 打造可擴充的計算引擎：抽象化折扣規則讓任何依照合約實作的折扣規則皆可擴充至促購引擎。 -->\n<hr>\n<h1 id=\"2-帶來的效益\" style=\"position:relative;\"><a href=\"#2-%E5%B8%B6%E4%BE%86%E7%9A%84%E6%95%88%E7%9B%8A\" aria-label=\"2 帶來的效益 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 帶來的效益</h1>\n<p>在這一小節我們會分享在使用進化後的促購引擎為我們帶來了什麼樣的實際效益。</p>\n<p>在新促購機制這個解決方案完成後，我們感受到下列三個明顯的效益：首先是，可擴充折扣規則；第二，加快開發速度；最後是，元件化促購引擎。接下來我們和大家分享每一個項目的效果與利益。</p>\n<p>接下來我們來說明一下第一項效益，<font color=\"red\"><strong>可擴充的折扣規則</strong></font>：透過抽象化折扣規則，實作相同合約的折扣規則皆可擴充至促購引擎，讓結帳流程可以呼叫並取得折扣資訊，使得我們有能力新增各類型或未知的折扣規則，讓商店可以更加靈活運用各種折扣活動，來滿足多變的市場需求。在今年第一季為止我們已經擴充了 8 種類型的折扣規則，例如：第 N 件打折、任選優惠價，以及滿額折現等等種類的折扣規則，而在今年第一季受惠的商店就已經達到約 740 家，我們目前也積極的新增其他折扣類型！</p>\n<p>第二項帶來的效益是<font color=\"red\"><strong>加快開發速度</strong></font>，在抽象化促購引擎將關注點分離後，新增折扣規則時僅須著重於該折扣規則的開發即可，相對的能夠加快我們的開發速度；而我們的開發速度也大幅度的提升約 2 至 4 倍，就像現今只需要約 2 週的開發時間，在過去則需 4 至 8 週的開發時間。這也意味著我們能夠更快的取得市場先機，為商店帶來更多的利益。</p>\n<p>最後還有一項效益是<font color=\"red\"><strong>促購引擎的元件化</strong></font>，我們將計算折扣的機制抽離購物車結帳流程後，元件化的促購引擎更容易被測試與驗證，這對於我們在開發與測試階段都有莫大的幫助，同時也更容易開發試算或模擬工具，讓設計促購活動時能離線試算，而更快速的知道折扣結果，可以告訴商店折扣後有沒有可能低於成本，也就能更有效率的與客戶溝通。</p>\n<hr>\n<h1 id=\"3-新的挑戰\" style=\"position:relative;\"><a href=\"#3-%E6%96%B0%E7%9A%84%E6%8C%91%E6%88%B0\" aria-label=\"3 新的挑戰 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 新的挑戰</h1>\n<p>在這一小節我們也揭露在這個新促購機制完成後，我們所接受到那些新的挑戰。</p>\n<p>在新促購機制完成後，我們接下來還有新的挑戰，首先，必須要考慮的是<strong>新舊促購機制的並存</strong>，在大部分都還是原有的促購機制下我們如何整合新的促購機制，既不能互相影響又要計算正確的折扣；以及<strong>有順序性的折扣規則</strong>，例如指定要先計算第 N 件折扣後再計算紅配綠折扣，類似像這樣的折扣順序；還有，<strong>折扣排除</strong>，在符合任選優惠後就不再適用第 N 件折扣；<strong>擇優</strong>，在眾多符合條件的折扣中選擇最優惠的折扣；最後，除了折扣活動外還有<strong>折價券</strong>這類的促購也要納入計算等等。當然，這些挑戰我們都會一一克服讓新促購引擎能更趨於完善。</p>\n<hr>\n<h1 id=\"4-總結\" style=\"position:relative;\"><a href=\"#4-%E7%B8%BD%E7%B5%90\" aria-label=\"4 總結 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 總結</h1>\n<p>最後一小節，我們來針對新促購機制的重點做個總結。</p>\n<p>藉由這個新促購機制的案例來看，在設計系統架構時，適當的運用物件導向程式設計概念，會讓我們的系統能更容易適應變化；而對系統進行良好的抽象化，也可以讓系統對於未來的擴充性與維護性都大幅上升；最後，確實在經過仔細思考分析後所設計的系統，能夠比事後再來最佳化更能夠減少浪費發揮效益，也能讓系統保持整潔、好維護、好理解以及速度快等等，這也是所有軟體工程師努力探求的極致！</p>\n<hr>\n<h1 id=\"5-附錄\" style=\"position:relative;\"><a href=\"#5-%E9%99%84%E9%8C%84\" aria-label=\"5 附錄 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 附錄</h1>\n<p>最後，這邊附上簡報中範例程式碼 GitHub 儲存庫的連結，有興趣的朋友歡迎來取用；同時也附上這次主題中的參考資料供大家延伸閱讀。</p>\n<h2 id=\"51-範例程式碼\" style=\"position:relative;\"><a href=\"#51-%E7%AF%84%E4%BE%8B%E7%A8%8B%E5%BC%8F%E7%A2%BC\" aria-label=\"51 範例程式碼 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.1. 範例程式碼</h2>\n<ul>\n<li><a href=\"https://github.com/Zhi-Wei/Andrew.DiscountDemo\">GitHub - Zhi-Wei/Andrew.DiscountDemo</a></li>\n</ul>\n<h2 id=\"52-參考資料\" style=\"position:relative;\"><a href=\"#52-%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\" aria-label=\"52 參考資料 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.2. 參考資料</h2>\n<ol>\n<li><a href=\"https://wiki.mbalib.com/zh-tw/%E4%BF%83%E9%94%80\">促銷 - MBA 智庫百科</a></li>\n<li><a href=\"https://www.itsfun.com.tw/%E9%8A%B7%E5%94%AE%E4%BF%83%E9%80%B2/wiki-0237365-7679935\">銷售促進-華人百科</a></li>\n<li><a href=\"https://columns.chicken-house.net/2020/03/10/interview-abstraction/\">架構面試題 #4 - 抽象化思考；折扣規則的設計機制 — 安德魯的部落格</a></li>\n<li><a href=\"https://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E5%8C%96_(%E8%A8%88%E7%AE%97%E6%A9%9F%E7%A7%91%E5%AD%B8)\">抽象化 (計算機科學) - 維基百科，自由的百科全書</a></li>\n</ol>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","tableOfContents":"<ul>\n<li><a href=\"#0-%E5%A4%A7%E7%B6%B1\">0. 大綱</a></li>\n<li>\n<p><a href=\"#1-%E6%96%B0%E4%BF%83%E8%B3%BC%E6%A9%9F%E5%88%B6-%E2%94%80%E2%94%80-%E7%B0%A1%E4%BB%8B%E6%96%B0%E4%BF%83%E8%B3%BC%E5%BC%95%E6%93%8E\">1. 新促購機制 ── 簡介新促購引擎</a></p>\n<ul>\n<li><a href=\"#11-%E8%83%8C%E6%99%AF\">1.1. 背景</a></li>\n<li><a href=\"#12-%E5%8B%95%E6%A9%9F\">1.2. 動機</a></li>\n<li><a href=\"#13-%E7%9B%AE%E6%A8%99\">1.3. 目標</a></li>\n<li><a href=\"#14-%E6%8C%91%E6%88%B0\">1.4. 挑戰</a></li>\n<li><a href=\"#15-%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%A1%88\">1.5. 解決方案</a></li>\n</ul>\n</li>\n<li><a href=\"#2-%E5%B8%B6%E4%BE%86%E7%9A%84%E6%95%88%E7%9B%8A\">2. 帶來的效益</a></li>\n<li><a href=\"#3-%E6%96%B0%E7%9A%84%E6%8C%91%E6%88%B0\">3. 新的挑戰</a></li>\n<li><a href=\"#4-%E7%B8%BD%E7%B5%90\">4. 總結</a></li>\n<li>\n<p><a href=\"#5-%E9%99%84%E9%8C%84\">5. 附錄</a></p>\n<ul>\n<li><a href=\"#51-%E7%AF%84%E4%BE%8B%E7%A8%8B%E5%BC%8F%E7%A2%BC\">5.1. 範例程式碼</a></li>\n<li><a href=\"#52-%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\">5.2. 參考資料</a></li>\n</ul>\n</li>\n</ul>","frontmatter":{"date":"2020/06/24","title":"抽象化系統設計思維以促購引擎為例","category":"Architecture","tags":["Promotion","OOD"],"author":"Zhi-Wei Lu","authorPhoto":{"childImageSharp":{"fluid":{"src":"/static/c21e192e755c9bfdf72a71c7e86f411d/0f3a1/zhiwei-lu.jpg","originalName":"zhiwei-lu.jpg"}}},"bannerPhoto":{"childImageSharp":{"fluid":{"src":"/static/ddc9aac5626703cfd55c575a0f9363d7/ee604/abstract-the-checkout-process.png","originalName":"abstract-the-checkout-process.png"}}},"youtubePath":"http://www.youtube.com/watch?v=xEBCpMVj5I0"},"fields":{"slug":"blog/Architecture/new-promotion-mechanism"}}},"pageContext":{"slug":"blog/Architecture/new-promotion-mechanism"}},"staticQueryHashes":["1351831723","2394719841"]}